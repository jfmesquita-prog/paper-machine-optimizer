function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  
  Logger.log('Dados recebidos: ' + JSON.stringify(data));

  if (data.type === 'hourly') {
    // Adiciona uma nova linha para entrada horária
    var rowData = [
      new Date(),  // Timestamp
      data.productionGrade || '',
      data.yankeeSpeed || '',
      data.yankeePressure || '',
      data.hoodsTempDrySide || '',
      data.hoodsTempWetSide || '',
      data.weight || '',
      data.wetPaste || '',
      '',  // Consumo de Gás Natural (vazio para entradas horárias)
      ''   // Consumo Objetivo de Gás (vazio para entradas horárias)
    ];
    sheet.appendRow(rowData);
    Logger.log('Nova entrada horária adicionada: ' + rowData.join(', '));
  } else if (data.type === 'shiftEnd') {
    // Atualiza o consumo de gás para as entradas do dia
    var lastRow = sheet.getLastRow();
    var dataRange = sheet.getRange(2, 1, lastRow - 1, 10);  // Assume 10 colunas
    var values = dataRange.getValues();
    
    var shiftDate = new Date(data.shiftDate);
    Logger.log('Atualizando consumo de gás para o dia: ' + shiftDate.toDateString());

    var updatedRows = 0;
    for (var i = values.length - 1; i >= 0; i--) {
      var rowDate = new Date(values[i][0]);
      if (rowDate.toDateString() === shiftDate.toDateString() && values[i][8] === '') {
        sheet.getRange(i + 2, 9, 1, 2).setValues([[data.gasConsumption, data.targetGasConsumption]]);
        Logger.log('Consumo de gás atualizado para a linha ' + (i + 2));
        updatedRows++;
      }
    }
    Logger.log('Total de linhas atualizadas: ' + updatedRows);
  }

  return ContentService.createTextOutput(JSON.stringify({success: true, message: 'Operação concluída com sucesso'}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = sheet.getDataRange().getValues();
  var headers = ['Timestamp', 'Artigo em Produção', 'Velocidade do Yankee', 'Pressão do Yankee', 
                 'Temperatura Campânula (Lado Seco)', 'Temperatura Campânula (Lado Húmido)', 
                 'Gramagem', 'Pasta Húmida', 'Consumo de Gás Natural', 'Consumo Objetivo de Gás'];
  
  var jsonData = data.map(function(row) {
    var rowData = {};
    for (var i = 0; i < headers.length; i++) {
      rowData[headers[i]] = row[i];
    }
    return rowData;
  });
  
  return ContentService.createTextOutput(JSON.stringify(jsonData))
    .setMimeType(ContentService.MimeType.JSON);
}
